{% extends "base.html" %}
{% block title %}Take Exam | ExamPro{% endblock %}

{% block content %}

<!-- Floating Exam Header -->
<div id="examHeader" class="fixed top-16 left-0 w-full z-40 transition-all duration-300">
    <div id="examHeaderInner" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl shadow-xl p-6 text-white flex flex-col md:flex-row md:items-center md:justify-between transition-all duration-300">
            <div id="examMeta">
                <h1 class="text-2xl font-bold">{{ exam.title }}</h1>
                <p class="text-indigo-100 text-sm">{{ exam.course.title }}</p>
            </div>

            <div class="mt-4 md:mt-0 flex items-center space-x-6">
                <div class="text-center">
                    <p class="text-xs text-indigo-100">Questions</p>
                    <p class="text-lg font-bold">{{ questions.count }}</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-indigo-100">Marks</p>
                    <p class="text-lg font-bold">{{ exam.total_marks }}</p>
                </div>
                <div id="timerBox" class="bg-white/20 px-4 py-2 rounded-lg text-center">
                    <p class="text-xs">Time Left</p>
                    <p id="timer" class="text-lg font-bold">--:--</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Page Spacer -->
<div class="h-48"></div>

<!-- Questions -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 space-y-8">
    {% for question in questions %}
    <div class="bg-white rounded-2xl shadow-lg p-8">
        <div class="flex justify-between items-center mb-4">
            <span class="bg-indigo-100 text-indigo-600 px-4 py-2 rounded-lg font-semibold">
                Question {{ forloop.counter }}
            </span>
            <span class="text-sm font-semibold text-green-600">2 marks</span>
        </div>
        
        <h2 class="text-lg font-semibold text-gray-900 mb-6">
            {{ question.text }}
        </h2>

        <div class="space-y-3">
            {% for choice in question.choices.all %}
            <label class="flex items-start p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-indigo-300 hover:bg-indigo-50 transition choice-label" data-question-id="{{ question.id }}" data-choice-id="{{ choice.id }}">
                <input type="radio" 
                       name="question_{{ question.id }}" 
                       value="{{ choice.id }}"
                       class="mt-1 h-5 w-5 text-indigo-600 answer-radio"
                       data-question-id="{{ question.id }}"
                       data-choice-id="{{ choice.id }}"
                       {% for answer in attempt.answers.all %}
                           {% if answer.question.id == question.id and answer.choice.id == choice.id %}
                               checked
                           {% endif %}
                       {% endfor %}>
                <div class="ml-4">
                    <span class="font-semibold text-gray-700 mr-2">{{ forloop.counter0|add:65|stringformat:"c" }}.</span>
                    <span class="text-gray-900">{{ choice.text }}</span>
                </div>
            </label>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Review & Submit Button -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-12 mb-12">
    <button id="reviewAnswersBtn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-semibold hover:from-indigo-700 hover:to-purple-700 transition shadow-xl">
        Review Answers & Submit
    </button>
</div>

{% endblock %}

{% block extra_js %}
<script>
/* ===========================
   HEADER TRANSITION ON SCROLL
=========================== */
const header = document.getElementById('examHeaderInner');
const meta = document.getElementById('examMeta');

window.addEventListener('scroll', () => {
    if (window.scrollY > 120) {
        header.classList.add('max-w-md');
        meta.classList.add('hidden');
    } else {
        header.classList.remove('max-w-md');
        meta.classList.remove('hidden');
    }
});

/* ===========================
   TIMER - Using server-calculated remaining time
=========================== */
let timeRemaining = {{ time_remaining }};  // Seconds remaining from server
const timerEl = document.getElementById('timer');

function updateTimer() {
    if (timeRemaining <= 0) {
        timerEl.textContent = "00:00";
        alert("Time's up! Your exam will be submitted automatically.");
        window.location.href = "{% url 'exam_confirm' exam.id %}";
        return;
    }

    const hours = Math.floor(timeRemaining / 3600);
    const minutes = Math.floor((timeRemaining % 3600) / 60);
    const seconds = timeRemaining % 60;

    if (hours > 0) {
        timerEl.textContent = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    } else {
        timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    timeRemaining--;
}

// Update immediately, then every second
updateTimer();
setInterval(updateTimer, 1000);

/* ===========================
   REAL-TIME ANSWER SAVING
=========================== */
const attemptId = {{ attempt.id }};
const radios = document.querySelectorAll('.answer-radio');

radios.forEach(radio => {
    radio.addEventListener('change', function() {
        const questionId = this.dataset.questionId;
        const choiceId = this.dataset.choiceId;
        
        // Visual feedback
        const labels = document.querySelectorAll(`label[data-question-id="${questionId}"]`);
        labels.forEach(label => {
            label.classList.remove('border-indigo-500', 'bg-indigo-50');
            label.classList.add('border-gray-200');
        });
        this.closest('label').classList.add('border-indigo-500', 'bg-indigo-50');
        this.closest('label').classList.remove('border-gray-200');
        
        // Save answer via AJAX
        fetch("{% url 'save_answer' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `attempt_id=${attemptId}&question_id=${questionId}&choice_id=${choiceId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                console.log('Answer saved successfully');
            }
        })
        .catch(error => console.error('Error saving answer:', error));
    });
});

// Get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

/* ===========================
   RESTORE SELECTED ANSWERS ON LOAD
=========================== */
document.addEventListener('DOMContentLoaded', function() {
    const checkedRadios = document.querySelectorAll('.answer-radio:checked');
    checkedRadios.forEach(radio => {
        const label = radio.closest('label');
        label.classList.add('border-indigo-500', 'bg-indigo-50');
        label.classList.remove('border-gray-200');
    });
});

/* ===========================
   REVIEW ANSWERS BUTTON
=========================== */
document.getElementById('reviewAnswersBtn').addEventListener('click', function() {
    const totalQuestions = {{ questions.count }};
    const answeredQuestions = document.querySelectorAll('.answer-radio:checked').length;
    const unanswered = totalQuestions - answeredQuestions;
    
    if (unanswered > 0) {
        const proceed = confirm(`You have answered ${answeredQuestions} out of ${totalQuestions} questions.\n${unanswered} question(s) remain unanswered.\n\nDo you want to review your answers?`);
        if (!proceed) {
            return;
        }
    }
    
    // Go to confirmation page
    window.location.href = "{% url 'exam_confirm' exam.id %}";
});

/* ===========================
   WARN BEFORE LEAVING PAGE
=========================== */
window.addEventListener('beforeunload', function (e) {
    e.preventDefault();
    e.returnValue = '';
    return '';
});
</script>
{% endblock %}